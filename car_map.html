<!DOCTYPE html>
<html>
<head>
  <title>Car Tracker â€“ Trip Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; display: flex; }
    
    /* Map Area */
    #map { height: 100vh; flex-grow: 1; }

    /* Sidebar for Trip Log */
    .sidebar {
        width: 300px; height: 100vh; background: #f8f9fa; 
        border-left: 2px solid #ddd; overflow-y: auto; display: flex; flex-direction: column;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }
    .header { padding: 15px; background: #343a40; color: white; }
    .header input { width: 90%; padding: 8px; margin-top: 10px; border-radius: 4px; border: none;}
    
    /* Stop List Items */
    .stop-item {
        padding: 15px; border-bottom: 1px solid #ddd; cursor: pointer; transition: background 0.2s;
    }
    .stop-item:hover { background: #e9ecef; }
    .stop-time { font-weight: bold; color: #d9534f; font-size: 14px; }
    .stop-duration { font-size: 12px; color: #666; margin-top: 4px; }
    
    /* Floating Status on Map */
    .map-status {
        position: absolute; top: 10px; left: 50px; z-index: 1000;
        background: white; padding: 8px 15px; border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; font-size: 13px;
    }
  </style>
</head>

<body>

<div id="map"></div>
<div class="map-status" id="status">Waiting for data...</div>

<div class="sidebar">
    <div class="header">
        <div>ðŸ“… <b>Trip History</b></div>
        <input type="date" id="datePicker">
    </div>
    <div id="stopsList">
        <div style="padding:20px; color:#777; text-align:center;">Select a date to view stops.</div>
    </div>
</div>

<script>
  // ðŸ”´ 1. CONFIG
  const firebaseConfig = {
    apiKey: "YAIzaSyBO8FGSZvqr0cFz-bNPWMN6H7ke2htfkNI",
    authDomain: "cartracker-c5bde.firebaseapp.com",
    projectId: "cartracker-c5bde",
  };
  
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const map = L.map('map').setView([21.1547, 72.7760], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);

  // ðŸ”´ 2. ICONS & LAYERS
  const carIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/3202/3202926.png', // Red Car
      iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -20]
  });

  let routeLine = L.polyline([], { color: '#007bff', weight: 5, opacity: 0.8 }).addTo(map);
  let stopMarkers = L.layerGroup().addTo(map);
  let carMarker = null;
  let unsubscribe = null;

  // ðŸ”´ 3. STOP DETECTION LOGIC
  function detectStops(points) {
    const listDiv = document.getElementById('stopsList');
    listDiv.innerHTML = ""; // Clear list
    stopMarkers.clearLayers(); // Clear map circles

    if (points.length < 2) return;

    let stopStart = points[0]; 
    let stopEnd = points[0];
    let stopCount = 0;

    // âš¡ SETTINGS: Adjust these if needed
    const MIN_STOP_TIME_MS = 2 * 60 * 1000; // 2 Minutes (Lowered for testing)
    const MAX_DRIFT_METERS = 60; // 60 meters drift allowed

    for (let i = 1; i < points.length; i++) {
        const p = points[i];
        const dist = map.distance([stopStart.lat, stopStart.lng], [p.lat, p.lng]);

        if (dist < MAX_DRIFT_METERS) {
            stopEnd = p; // Still parked
        } else {
            // Car moved. Was the last stop long enough?
            checkAndAddStop(stopStart, stopEnd, MIN_STOP_TIME_MS, ++stopCount);
            stopStart = p;
            stopEnd = p;
        }
    }

    // Check final stop (current parking spot)
    checkAndAddStop(stopStart, stopEnd, MIN_STOP_TIME_MS, ++stopCount, true);
  }

  function checkAndAddStop(start, end, minTime, count, isCurrent = false) {
      const duration = end.ts - start.ts;
      if (duration < minTime) return; // Too short, ignore

      // 1. Format Time
      const mins = Math.floor(duration / 60000);
      const hours = Math.floor(mins / 60);
      const m = mins % 60;
      const timeStr = hours > 0 ? `${hours}h ${m}m` : `${mins} min`;
      
      const startTime = new Date(start.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const endTime = new Date(end.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      // 2. Add to Sidebar List
      const item = document.createElement('div');
      item.className = 'stop-item';
      item.innerHTML = `
          <div class="stop-time">ðŸ›‘ Stop #${count} (${startTime})</div>
          <div class="stop-duration">
             Duration: <b>${timeStr}</b><br>
             Until: ${isCurrent ? "Now" : endTime}
          </div>
      `;
      // Click to Zoom
      item.onclick = () => {
          map.setView([start.lat, start.lng], 16);
          L.popup().setLatLng([start.lat, start.lng])
            .setContent(`<b>Stop #${count}</b><br>Spent ${timeStr} here.`)
            .openOn(map);
      };
      document.getElementById('stopsList').appendChild(item);

      // 3. Add Circle to Map
      L.circleMarker([start.lat, start.lng], {
          color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 10
      }).addTo(stopMarkers).bindPopup(`<b>Stop #${count}</b><br>${timeStr}`);
  }

  // ðŸ”´ 4. LOAD HISTORY
  function loadHistory(dateString) {
      if (unsubscribe) unsubscribe();
      routeLine.setLatLngs([]);
      stopMarkers.clearLayers();
      if (carMarker) { map.removeLayer(carMarker); carMarker = null; }

      document.getElementById('status').innerText = `Loading ${dateString}...`;
      document.getElementById('stopsList').innerHTML = '<div style="padding:20px; text-align:center;">Loading data...</div>';

      unsubscribe = db.collection("devices")
        .doc("car_001")
        .collection("history")
        .doc(dateString)
        .collection("points")
        .orderBy("ts")
        .onSnapshot((snapshot) => {
            const rawPoints = [];
            const latlngs = [];

            snapshot.forEach(doc => {
                const d = doc.data();
                if (d.lat && d.lng && d.ts) {
                    let ts = d.ts;
                    if (d.ts.toDate) ts = d.ts.toDate().getTime();
                    rawPoints.push({ lat: d.lat, lng: d.lng, ts: ts });
                    latlngs.push([d.lat, d.lng]);
                }
            });

            if (rawPoints.length === 0) {
                document.getElementById('status').innerText = "No data.";
                document.getElementById('stopsList').innerHTML = '<div style="padding:20px; text-align:center;">No driving data found for this date.</div>';
                return;
            }

            document.getElementById('status').innerText = `Data Points: ${rawPoints.length}`;

            // Draw Route
            routeLine.setLatLngs(latlngs);

            // Detect Stops
            detectStops(rawPoints);

            // Car Icon
            const last = rawPoints[rawPoints.length - 1];
            if (!carMarker) {
                carMarker = L.marker([last.lat, last.lng], {icon: carIcon}).addTo(map);
                map.setView([last.lat, last.lng], 14);
            } else {
                carMarker.setLatLng([last.lat, last.lng]);
            }

        }, (err) => {
            console.error(err);
            alert("Error: " + err.message);
        });
  }

  // ðŸ”´ 5. INIT
  const datePicker = document.getElementById('datePicker');
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const d = String(now.getDate()).padStart(2, '0');
  const today = `${y}-${m}-${d}`;
  
  datePicker.value = today;
  loadHistory(today);
  
  datePicker.addEventListener('change', (e) => loadHistory(e.target.value));

</script>
</body>
</html>
