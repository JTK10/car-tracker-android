<!DOCTYPE html>
<html>
<head>
  <title>Car Tracker ‚Äì Map Only</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; width: 100vw; }

    /* Floating Control Box */
    .controls {
        position: absolute; top: 10px; right: 10px; z-index: 1000;
        background: white; padding: 10px 15px; border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        display: flex; flex-direction: column; gap: 5px;
        min-width: 150px;
    }
    .status-text { font-size: 13px; color: #555; font-weight: bold; margin-bottom: 5px;}
    input[type="date"] {
        padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="controls">
    <div class="status-text" id="status">Loading...</div>
    <input type="date" id="datePicker">
</div>

<script>
  // üî¥ 1. CONFIGURATION
  const firebaseConfig = {
    apiKey: "YAIzaSyBO8FGSZvqr0cFz-bNPWMN6H7ke2htfkNI",
    authDomain: "cartracker-c5bde.firebaseapp.com",
    projectId: "cartracker-c5bde",
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // üî¥ 2. MAP SETUP
  const map = L.map('map').setView([21.1547, 72.7760], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // üî¥ 3. ICONS
  const carIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/3202/3202926.png', // Red Car
      iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -20]
  });

  const parkIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/178/178008.png', // Parking "P"
      iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
  });

  // Layers
  let routeLine = L.polyline([], { color: 'blue', weight: 4, opacity: 0.6 }).addTo(map);
  let stopLayer = L.layerGroup().addTo(map); // Holds P markers
  let carMarker = null;
  let unsubscribe = null;

  // üî¥ 4. STOP DETECTION LOGIC
  function detectStops(points) {
    stopLayer.clearLayers(); // Clear old parking spots

    if (points.length < 2) return;

    let stopStart = points[0]; 
    let stopEnd = points[0];

    // ‚ö° SETTINGS: Adjust sensitivity here
    const MIN_STOP_TIME_MS = 2 * 60 * 1000; // 2 Minutes
    const MAX_DRIFT_METERS = 50; // 50 meters drift allowed

    for (let i = 1; i < points.length; i++) {
        const p = points[i];
        const dist = map.distance([stopStart.lat, stopStart.lng], [p.lat, p.lng]);

        if (dist < MAX_DRIFT_METERS) {
            // Car is still in the same area
            stopEnd = p;
        } else {
            // Car moved far enough -> Check if previous cluster was a stop
            processStop(stopStart, stopEnd, MIN_STOP_TIME_MS);
            
            // Reset for next cluster
            stopStart = p;
            stopEnd = p;
        }
    }
    // Check final stop (current position)
    processStop(stopStart, stopEnd, MIN_STOP_TIME_MS, true);
  }

  function processStop(start, end, minTime, isCurrent = false) {
      const duration = end.ts - start.ts;
      if (duration < minTime) return; // Ignore short stops (traffic lights, etc.)

      // Format Duration
      const mins = Math.floor(duration / 60000);
      const hours = Math.floor(mins / 60);
      const m = mins % 60;
      const timeStr = hours > 0 ? `${hours} hr ${m} min` : `${mins} min`;

      // Format Times
      const startTime = new Date(start.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const endTime = new Date(end.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      const popupMsg = isCurrent 
        ? `<b>Currently Parked</b><br>‚è≥ Since: ${startTime}<br>‚è± Duration: ${timeStr}`
        : `<b>üÖøÔ∏è STOPPED</b><br>üïí ${startTime} - ${endTime}<br>‚è± Duration: ${timeStr}`;

      // Add "P" Marker to map
      L.marker([start.lat, start.lng], {icon: parkIcon})
       .addTo(stopLayer)
       .bindPopup(popupMsg);
  }

  // üî¥ 5. LOAD DATA
  function loadHistory(dateString) {
      if (unsubscribe) unsubscribe();
      
      // Reset Map
      routeLine.setLatLngs([]);
      stopLayer.clearLayers();
      if (carMarker) { map.removeLayer(carMarker); carMarker = null; }

      document.getElementById('status').innerText = `Loading ${dateString}...`;

      unsubscribe = db.collection("devices")
        .doc("car_001")
        .collection("history")
        .doc(dateString)
        .collection("points")
        .orderBy("ts")
        .onSnapshot((snapshot) => {
            const rawPoints = [];
            const latlngs = [];

            if (snapshot.empty) {
                document.getElementById('status').innerText = "No data.";
                return;
            }

            snapshot.forEach(doc => {
                const d = doc.data();
                if (d.lat && d.lng && d.ts) {
                    let ts = d.ts;
                    if (d.ts.toDate) ts = d.ts.toDate().getTime(); // Handle Firestore Timestamp
                    
                    rawPoints.push({ lat: d.lat, lng: d.lng, ts: ts });
                    latlngs.push([d.lat, d.lng]);
                }
            });

            document.getElementById('status').innerText = `${rawPoints.length} points found`;

            // Draw Blue Path
            routeLine.setLatLngs(latlngs);

            // Add Parking Markers
            detectStops(rawPoints);

            // Add Car Marker (Current Location)
            if (rawPoints.length > 0) {
                const last = rawPoints[rawPoints.length - 1];
                const lastPos = [last.lat, last.lng];

                if (!carMarker) {
                    carMarker = L.marker(lastPos, {icon: carIcon}).addTo(map);
                    map.setView(lastPos, 14); // Zoom to car
                } else {
                    carMarker.setLatLng(lastPos);
                }
                
                // Add popup to car
                carMarker.bindPopup(`<b>Current Location</b><br>${new Date(last.ts).toLocaleTimeString()}`);
            }
        });
  }

  // üî¥ 6. INIT
  const datePicker = document.getElementById('datePicker');
  
  // Set to Today
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  datePicker.value = today;

  loadHistory(today);

  datePicker.addEventListener('change', (e) => loadHistory(e.target.value));

</script>
</body>
</html>
