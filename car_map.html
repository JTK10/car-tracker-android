<!DOCTYPE html>
<html>
<head>
  <title>Car Tracker â€“ Debug Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; width: 100vw; }
    
    .controls {
        position: absolute; top: 10px; right: 10px; z-index: 1000;
        background: white; padding: 10px; border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="controls">
    <div id="status" style="font-size:12px; font-weight:bold; margin-bottom:5px;">Waiting...</div>
    <input type="date" id="datePicker">
</div>

<script>
  // 1. CONFIGURATION
  const firebaseConfig = {
    apiKey: "YAIzaSyBO8FGSZvqr0cFz-bNPWMN6H7ke2htfkNI",
    authDomain: "cartracker-c5bde.firebaseapp.com",
    projectId: "cartracker-c5bde",
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const map = L.map('map').setView([21.1547, 72.7760], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);

  const carIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/3202/3202926.png',
      iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -20]
  });

  let routeLine = L.polyline([], { color: 'blue', weight: 4, opacity: 0.6 }).addTo(map);
  let stopLayer = L.layerGroup().addTo(map); 
  let carMarker = null;

  // ðŸ”´ DEBUG LOGIC FOR STOPS
  function detectStops(points) {
    stopLayer.clearLayers(); 

    if (points.length < 2) return;

    let stopStart = points[0]; 
    let stopEnd = points[0];

    // ðŸ‘‡ EXTREME SETTINGS FOR TESTING
    const MIN_STOP_TIME_MS = 60 * 1000; // 1 Minute (Very short to catch everything)
    const MAX_DRIFT_METERS = 100; // 100 meters (Very loose)

    console.log("--- STARTING ANALYSIS ---");

    for (let i = 1; i < points.length; i++) {
        const p = points[i];
        
        // Calculate distance in meters
        const dist = map.distance([stopStart.lat, stopStart.lng], [p.lat, p.lng]);

        if (dist < MAX_DRIFT_METERS) {
            stopEnd = p; // Still in same spot
        } else {
            // Car moved. Calculate how long it was there.
            const duration = stopEnd.ts - stopStart.ts;
            const minutes = (duration / 60000).toFixed(1);

            console.log(`Checking stop... Dist moved: ${dist.toFixed(0)}m, Duration: ${minutes} min`);

            if (duration > MIN_STOP_TIME_MS) {
                console.log("âœ… VALID STOP FOUND!");
                drawStopCircle(stopStart, stopEnd, duration);
            }

            // Reset
            stopStart = p;
            stopEnd = p;
        }
    }

    // Final Stop Check
    const finalDuration = stopEnd.ts - stopStart.ts;
    if (finalDuration > MIN_STOP_TIME_MS) {
        console.log("âœ… FINAL STOP FOUND!");
        drawStopCircle(stopStart, stopEnd, finalDuration, true);
    }
    console.log("--- END ANALYSIS ---");
  }

  function drawStopCircle(start, end, duration, isCurrent = false) {
      const mins = Math.floor(duration / 60000);
      const timeStr = mins > 60 ? (mins/60).toFixed(1) + " hr" : mins + " min";
      const startTime = new Date(start.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      L.circleMarker([start.lat, start.lng], {
          radius: 10,              
          fillColor: "#ff0000",   
          color: "#fff",       
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
      }).addTo(stopLayer)
      .bindPopup(`<b>Stopped: ${timeStr}</b><br>Since: ${startTime}`)
      .bindTooltip(timeStr, {permanent: true, direction: "top", className: "my-label"});
  }

  function loadHistory(dateString) {
      routeLine.setLatLngs([]);
      stopLayer.clearLayers();
      if (carMarker) { map.removeLayer(carMarker); carMarker = null; }

      document.getElementById('status').innerText = `Loading...`;

      db.collection("devices").doc("car_001").collection("history").doc(dateString).collection("points")
        .orderBy("ts")
        .onSnapshot((snapshot) => {
            const rawPoints = [];
            const latlngs = [];

            snapshot.forEach(doc => {
                const d = doc.data();
                if (d.lat && d.lng && d.ts) {
                    let ts = d.ts;
                    
                    // ðŸ”´ FIX: Handle Timestamp conversion safely
                    if (d.ts.toDate) {
                        ts = d.ts.toDate().getTime();
                    } else if (typeof d.ts === "string") {
                        ts = new Date(d.ts).getTime(); // Try parsing string
                    }

                    if (!isNaN(ts)) {
                        rawPoints.push({ lat: d.lat, lng: d.lng, ts: ts });
                        latlngs.push([d.lat, d.lng]);
                    }
                }
            });

            document.getElementById('status').innerText = `${rawPoints.length} points`;
            routeLine.setLatLngs(latlngs);
            detectStops(rawPoints); // Run logic

            if (rawPoints.length > 0) {
                const last = rawPoints[rawPoints.length - 1];
                if (!carMarker) {
                    carMarker = L.marker([last.lat, last.lng], {icon: carIcon}).addTo(map);
                    map.setView([last.lat, last.lng], 14);
                } else {
                    carMarker.setLatLng([last.lat, last.lng]);
                }
            }
        });
  }

  const datePicker = document.getElementById('datePicker');
  const today = new Date().toISOString().split('T')[0];
  datePicker.value = today;
  loadHistory(today);
  datePicker.addEventListener('change', (e) => loadHistory(e.target.value));

</script>

<style>
  /* Make the text label readable */
  .my-label {
      background: rgba(255,255,255,0.8);
      border: 1px solid red;
      color: red;
      font-weight: bold;
  }
</style>
</body>
</html>
