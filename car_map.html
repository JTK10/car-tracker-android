<!DOCTYPE html>
<html>
<head>
  <title>Car Tracker â€“ Live Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .status-box {
        position: absolute; top: 10px; right: 10px; z-index: 1000;
        background: white; padding: 10px; border-radius: 5px;
        box-shadow: 0 0 5px rgba(0,0,0,0.3); font-family: sans-serif;
    }
  </style>
</head>

<body>
<div id="map"></div>
<div class="status-box" id="status">Waiting for data...</div>

<script>
  // ðŸ”´ 1. VERIFY YOUR CONFIG IS CORRECT
  const firebaseConfig = {
    apiKey: "YAIzaSyBO8FGSZvqr0cFz-bNPWMN6H7ke2htfkNI",
    authDomain: "cartracker-c5bde.firebaseapp.com",
    projectId: "cartracker-c5bde",
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();

  // Initialize Map
  const map = L.map('map').setView([21.1547, 72.7760], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  let marker = null;
  let routeLine = L.polyline([], { color: 'blue', weight: 4 }).addTo(map);

  // ðŸ”´ 2. GENERATE DYNAMIC DATE (YYYY-MM-DD)
  // This ensures we look for TODAY'S data, not an old date.
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const today = `${year}-${month}-${day}`; 

  console.log("Listening for data at path: devices/car_001/history/" + today + "/points");
  document.getElementById('status').innerText = "Checking: " + today;

  // ðŸ”´ 3. REAL-TIME LISTENER (onSnapshot)
  db.collection("devices")
    .doc("car_001")
    .collection("history")
    .doc(today)
    .collection("points")
    .orderBy("ts") // Ensure your data has a 'ts' (timestamp) field
    .onSnapshot((snapshot) => {
      
      const path = [];
      
      if (snapshot.empty) {
        console.log("No data found for today yet.");
        document.getElementById('status').innerText = "No data for " + today;
        return;
      }

      snapshot.forEach(doc => {
        const d = doc.data();
        if (d.lat && d.lng) {
          path.push([d.lat, d.lng]);
        }
      });

      console.log(`Received ${path.length} points.`);
      document.getElementById('status').innerText = `Tracking: ${path.length} points`;

      // Draw the route
      routeLine.setLatLngs(path);

      // Update Marker position
      if (path.length > 0) {
        const lastPosition = path[path.length - 1];
        
        if (!marker) {
          marker = L.marker(lastPosition).addTo(map);
          map.setView(lastPosition, 16); // Zoom in on first load
        } else {
          marker.setLatLng(lastPosition);
          // Optional: Keep camera centered on car
          // map.setView(lastPosition); 
        }
      }

    }, (error) => {
      console.error("Firebase Error:", error);
      document.getElementById('status').innerText = "Error: " + error.message;
      alert("Database Error! Check Console (F12)");
    });

</script>

</body>
</html>
